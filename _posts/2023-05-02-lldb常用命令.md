---
layout: post
title:  lldb常用命令
categories: 安全技术
tag:    
---


## 1. 语法格式

`<command> [<subcommand> [<subcommand>...]] <action> [-options [option-value]] [argument [argument...]]`

- `<command>和<subcommand>`：命令/子命令，LLDB调试命令的名称。命令和子命令按层级结构来安排，一个命令对象为跟随其的子命令对象创建一个上下文，子命令又为其子命令创建一个上下文，依次类推。
- `<action>`：执行命令的操作
- `<option>`：命令选项
- `<argument>`：命令的参数
- `[]`：表示可选


## 2. 持久化和自定义命令

LLDB有了一个启动时加载的文件`/.lldbinit`，每次启动都会加载。所以一些初始化的工作，我们可以写入`/.lldbinit`中，比如给命令定义别名等。但是由于这时候程序还没有真正运行，也有部分操作无法在里面玩，比如设置断点。一些便利调试命令可以安装Facebook的Chisel

添加步骤：

1. 打开终端，输入vi ~/.lldbinit进入文件编辑。
2. 写入自定义内容，创建一个命令别名如：command alias 打印堆栈 thread backtrace。
3. 然后ESC键，出现冒号后输入wq, enter键保存并退出编辑。

## 3. 打印值、修改值、调用方法

### 3.1. expression

expression命令的作用是执行一个表达式，并将表达式返回的结果输出，可以打印又可以修改值。

`expression <cmd-options> -- <expr>`

1. `<cmd-options>`：命令选项，一般情况下使用默认的即可，不需要特别标明。
2. `--`: 命令选项结束符，表示所有的命令选项已经设置完毕，如果没有命令选项，--可以省略
3. `<expr>`: 要执行的表达式

e.g.

1. 执行某个表达式

```r
# 改变颜色
(lldb) expression -- self.view.backgroundColor = [UIColor redColor]
# 刷新界面
(lldb) expression -- (void)[CATransaction flush]
```

2. 将返回值输出

```r
(lldb) expression -- self
(ViewController *) $0 = 0x0000000121d0fab0
```

### 3.2. p, po

打印相关的命令有：p、po。p 和 po 的区别在于使用 po 只会输出对应的值，而 p 则会返回值的类型以及命令结果的引用名。

```r
(lldb) p (CGFloat)self.view.frame.size.width
(CGFloat) $3 = 414
(lldb) po (CGFloat)self.view.frame.size.width
414

(lldb) p self
(ViewController *) $2 = 0x0000000121d0fab0
(lldb) po self
<ViewController: 0x121d0fab0>

# 结论
# po：输出值
# p：输出值+值类型+引用名+内存地址
```

### 3.3. call

在断点调用某个方法，并输出此方法的返回值

```r
(lldb) call [self.view backgroundColor]
(UIDeviceRGBColor *) $15 = 0x0000000283c14240

# call：同样为输出值+值类型+引用名
```

## 4. Thread

### 4.1. 堆栈打印

如果嫌堆栈打印太长，可以加一个值限制，如bt 5，只打印5帧

```r
(lldb) bt 5
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 3.1
  * frame #0: 0x000000010068a63c TestRuntimeDemo`-[ViewController viewDidLoad](self=0x0000000121d0fab0, _cmd="viewDidLoad") at ViewController.m:24
    frame #1: 0x00000001ddd7220c UIKitCore`-[UIViewController loadViewIfRequired] + 1000
    frame #2: 0x00000001ddd7263c UIKitCore`-[UIViewController view] + 28
    frame #3: 0x00000001de370848 UIKitCore`-[UIWindow addRootViewControllerViewIfPossible] + 136
    frame #4: 0x00000001de370df0 UIKitCore`-[UIWindow _setHidden:forced:] + 272
```

查看线程列表，第一个线程为当前执行线程：

```r
(lldb) thread list
```

### 4.2. 跳出当前方法的执行

Debug的时候，也许会因为各种原因，我们不想让代码执行某个方法，或者要直接返回一个想要的值。这时候就使用 thread return。

```r
# 跳出方法
(lldb) thread return
# 让带有返回int值的方法直接跳出，并返回值10
(lldb) thread return 10
```

### 4.3. 流程控制

```r
# 继续
(lldb) continue或c
# 下一步
(lldb) next或n
# 进入
(lldb) step或s
# 跳出
(lldb) finish或f
```

### 4.4. 跳帧

跳帧到第1帧。

```r
(lldb) frame select 1
```

### 4.5. 查看帧变量

```r
(lldb) frame variable
(ViewController *) self = 0x0000000102c107e0
(SEL) _cmd = "viewDidLoad"
```

## 5. Image

### 5.1. 查找崩溃位置

打印堆栈

```r
Stack Trace: (
    0   CoreFoundation                      0x00000001b1137eb8 <redacted> + 252
    1   libobjc.A.dylib                     0x00000001b0309a40 objc_exception_throw + 56
    2   CoreFoundation                      0x00000001b10af470 _CFArgv + 0
    3   CoreFoundation                      0x00000001b103f76c <redacted> + 0
    4   ShareSDKDemo                        0x0000000100d113d4 -[MOBPlatformViewController tableView:cellForRowAtIndexPath:] + 1132
    5   UIKitCore                           0x00000001de560540 <redacted> + 684
    6   UIKitCore                           0x00000001de560a88 <redacted> + 80
    7   UIKitCore                           0x00000001de52c160 <redacted> + 2256
    8   UIKitCore                           0x00000001de54a04c <redacted> + 140
    9   UIKitCore                           0x00000001de7deea4 <redacted> + 1380
    10  QuartzCore                          0x00000001b572ac70 <redacted> + 184
    11  QuartzCore                          0x00000001b572fc00 <redacted> + 324
    12  QuartzCore                          0x00000001b568e718 <redacted> + 340
    13  QuartzCore                          0x00000001b56bd04c <redacted> + 608
    14  UIKitCore                           0x00000001de36201c <redacted> + 256
    15  CoreFoundation                      0x00000001b10c77a8 <redacted> + 32
    16  CoreFoundation                      0x00000001b10c243c <redacted> + 412
    17  CoreFoundation                      0x00000001b10c29dc <redacted> + 1264
    18  CoreFoundation                      0x00000001b10c21cc CFRunLoopRunSpecific + 436
    19  GraphicsServices                    0x00000001b3339584 GSEventRunModal + 100
    20  UIKitCore                           0x00000001de339054 UIApplicationMain + 212
    21  ShareSDKDemo                        0x0000000100d10328 main + 148
    22  libdyld.dylib                       0x00000001b0b82bb4 <redacted> + 4
)
```

寻找上面堆栈项目的标识，看到frame4位置，你只需如下操作查找位置：

```r
(lldb) image lookup -a 0x0000000100d113d4
      Address: ShareSDKDemo[0x00000001000313d4] (ShareSDKDemo.__TEXT.__text + 173816)
      Summary: ShareSDKDemo`-[MOBPlatformViewController tableView:cellForRowAtIndexPath:] + 1132 at MOBPlatformViewController.m:93
```

项目中`MOBPlatformViewController.m:93行`就是触发异常位置，当然我们也可以在Xcode中添加一个All Exceptions类型的异常断点能直接定位到程序代码执行奔溃位置。

### 5.2. 查找方法来源

此命令可以用来查找方法的来源(包括第三方SDK的方法)。例如查找test方法

```r
(lldb) image lookup -n test
2 matches found in /Users/xxx/Library/Developer/Xcode/DerivedData/TestRuntimeDemo-aiszjzwyjeynznfgpbzrfdjolegb/Build/Products/Debug-iphoneos/TestRuntimeDemo.app/TestRuntimeDemo:
        Address: TestRuntimeDemo[0x0000000100006358] (TestRuntimeDemo.__TEXT.__text + 472)
        Summary: TestRuntimeDemo`-[Son test] at Son.m:24        Address: TestRuntimeDemo[0x0000000100006744] (TestRuntimeDemo.__TEXT.__text + 1476)
        Summary: TestRuntimeDemo`-[Person test] at Person.m:25
```

### 5.3. 查看成员

查看某个class的所有属性和成员变量。

```r
(lldb) image lookup -t ViewController
Best match found in /Users/xxx/Library/Developer/Xcode/DerivedData/TestRuntimeDemo-aiszjzwyjeynznfgpbzrfdjolegb/Build/Products/Debug-iphoneos/TestRuntimeDemo.app/TestRuntimeDemo:
id = {0x30000002b}, name = "ViewController", byte-size = 24, decl = ViewController.h:11, compiler_type = "@interface ViewController : UIViewController{
    NSString * _navTitle;
    NSString * _eventCode;
}
@property ( getter = navTitle,setter = setNavTitle:,readwrite,copy,nonatomic ) NSString * navTitle;
@property ( getter = eventCode,setter = setEventCode:,readwrite,copy,nonatomic ) NSString * eventCode;
@end"
```

## 6. breakpoint

### 6.1. 文件名+行号

在Xcode的代码编辑界面，在某一行点下断点，此操作与`breakpoint set -f xxx -l xxx`命令相同

```r
(lldb) breakpoint set -f ViewController.m -l 30
Breakpoint 3: where = TestRuntimeDemo`-[ViewController viewDidLoad] + 476 at ViewController.m:30, address = 0x0000000104e9232c
```

### 6.2. 函数名断点

#### 6.2.1. 方法名断点

```r
(lldb) breakpoint set -n viewDidLoad
Breakpoint 11: 240 locations.
```

Xcode也有函数名断点，通过添加符号断点"Symbolic Breakpoint" Symbol值填写viewDidLoad就与上面的lldb命令等同，同时Xcode还提示含有viewDidLoad方法的每个类显示出断点的位置(行号)。

#### 6.2.2. 类中方法断点

```r
(lldb) breakpoint set -n "-[MobShareViewController viewDidLoad]"
Breakpoint 13: where = ShareSDKDemo`-[MobShareViewController viewDidLoad] + 40 at MobShareViewController.m:48, address = 0x00000001008186f8
```

Xcode可通过符号断点"Symbolic Breakpoint" Symbol值填写"-[类名 方法名]"来实现，通过符号断点也可以跟踪C/C++函数。

### 6.3. 条件断点

和Xcode中符号断点功能相同，如在MOBQQViewController.m的第50行加断点并且条件为parameters不为nil。操作如下：

```r
lldb) breakpoint set -f MOBQQViewController.m -l 50 -c "parameters != nil"
Breakpoint 6: where = ShareSDKDemo`-[MOBQQViewController shareText] + 160 at MOBQQViewController.m:50, address = 0x0000000102fbaee0
```

### 6.4. 查看断点列表

```r
(lldb) breakpoint list
Current breakpoints:
1: names = {'objc_exception_throw', '__cxa_throw'}, locations = 2, resolved = 2, hit count = 0

  1.1: where = libobjc.A.dylib`objc_exception_throw, address = 0x0000000195401a08, resolved, hit count = 0 
  1.2: re-exported target = libc++abi.dylib`__cxa_throw, address = 0x00000001953f49bc, resolved, hit count = 0 

2: file = '/Users/xxx/Documents/Develop/svn_develop/ShareSDK/Sample/ShareSDKDemo/ShareSDKDemo/PlatformViewControllers/MOBQQViewController.m', line = 32, exact_match = 0, locations = 1, resolved = 1, hit count = 0

  2.1: where = ShareSDKDemo`-[MOBQQViewController shareText] + 56 at MOBQQViewController.m:32, address = 0x0000000104fdecb8, resolved, hit count = 0 
```

### 6.5. 禁用/启用断点

```r
(lldb) breakpoint disable 2
1 breakpoints disabled.
(lldb) breakpoint list
Current breakpoints:
1: names = {'objc_exception_throw', '__cxa_throw'}, locations = 2, resolved = 2, hit count = 0

  1.1: where = libobjc.A.dylib`objc_exception_throw, address = 0x0000000195401a08, resolved, hit count = 0 
  1.2: re-exported target = libc++abi.dylib`__cxa_throw, address = 0x00000001953f49bc, resolved, hit count = 0 

2: file = '/Users/xxx/Documents/Develop/svn_develop/ShareSDK/Sample/ShareSDKDemo/ShareSDKDemo/PlatformViewControllers/MOBQQViewController.m', line = 32, exact_match = 0, locations = 1 Options: disabled 

  2.1: where = ShareSDKDemo`-[MOBQQViewController shareText] + 56 at MOBQQViewController.m:32, address = 0x0000000104fdecb8, unresolved, hit count = 0 
```

### 6.6. 移除断点

```r
(lldb) breakpoint delete 2
1 breakpoints deleted; 0 breakpoint locations disabled.
(lldb) breakpoint list
Current breakpoints:
1: names = {'objc_exception_throw', '__cxa_throw'}, locations = 2, resolved = 2, hit count = 0

  1.1: where = libobjc.A.dylib`objc_exception_throw, address = 0x0000000195401a08, resolved, hit count = 0 
  1.2: re-exported target = libc++abi.dylib`__cxa_throw, address = 0x00000001953f49bc, resolved, hit count = 0 

3: name = '', locations = 0 (pending)
```

## 7. 别名

LLDB中已经有一些命令的别名，比如p是frame variable的别名，p view实际上是frame variable view。除了系统自建的LLDB别名，你也可以自定义别名。

### 7.1. 自定义别名

LLDB完整的命令有时候是很长的，例如image lookup --address这个命令。为了方便日常使用，提高效率，LLDB命令提供通过简称的方式调用命令。

```r
(lldb) command alias 打印堆栈 thread backtrace
(lldb) 打印堆栈 3
  thread #3
    frame #0: 0x0000000195e4ece8 libsystem_pthread.dylib`start_wqthread
```

上面3表示线程标识 可以通过Xcode左侧Debug栏查看线程，不建议使用中文，这里仅测试

### 7.2. 带参数别名

```r
(lldb) command alias 删除断点 breakpoint delete %1
(lldb) breakpoint list
(lldb) 删除断点 3
```

### 7.3. 创建别名持久化

## 8. 汇编调试（Xcode->Debug->Debug workflow->Always Show Disassembly）

查看寄存器

```r
(lldb) register read --all
General Purpose Registers:
        x0 = 0x00000001046240d8  @"test_Son"
        x1 = 0x00000001a9bd3b82
        x2 = 0x0000000000000001
        x3 = 0x0000000000000000
        x4 = 0x000000016b7e10d8
        x5 = 0x0000000000000040
        x6 = 0x006e6f737265505f
        x7 = 0x000000000000003a
        x8 = 0x00000001046250c0  "numberWithInt:"
        x9 = 0x00000001046250e0  (void *)0x00000001d002a5c8: NSNumber
       x10 = 0x0000000000000303
       x11 = 0x00000001d24ceb15
       x12 = 0x00000001d24ceb15
       x13 = 0x0000000000000008
       x14 = 0x000000000000001f
       x15 = 0x0000000080000000
       x16 = 0x000000019541b874  libobjc.A.dylib`objc_unsafeClaimAutoreleasedReturnValue
       x17 = 0x0000000104624010  (void *)0x00000001048b4528: initialPoolContent + 792
       x18 = 0x0000000000000000
       x19 = 0x00000001d005f9d4  UIKitCore`_UIApplicationLinkedOnVersion
       x20 = 0x0000000155e13210
       x21 = 0x0000000000000018
       x22 = 0x00000001c39754b1  "count"
       x23 = 0x0000000000000000
       x24 = 0x0000000000000001
       x25 = 0x0000000000000001
       x26 = 0x0000000000000280
       x27 = 0x0000000000000010
       x28 = 0x00000002810e87e0
        fp = 0x000000016b7e1360
        lr = 0x00000001046220e8  TestRuntimeDemo`-[ViewController viewDidLoad] + 184 at ViewController.m:28
        sp = 0x000000016b7e12d0
        pc = 0x00000001046220fc  TestRuntimeDemo`-[ViewController viewDidLoad] + 204 at ViewController.m:29
      cpsr = 0x80000000
        w0 = 0x046240d8
        w1 = 0xa9bd3b82
        w2 = 0x00000001
        w3 = 0x00000000
        w4 = 0x6b7e10d8
        w5 = 0x00000040
        w6 = 0x7265505f
        w7 = 0x0000003a
        w8 = 0x046250c0
        w9 = 0x046250e0
       w10 = 0x00000303
       w11 = 0xd24ceb15
       w12 = 0xd24ceb15
       w13 = 0x00000008
       w14 = 0x0000001f
       w15 = 0x80000000
       w16 = 0x9541b874
       w17 = 0x04624010
       w18 = 0x00000000
       w19 = 0xd005f9d4
       w20 = 0x55e13210
       w21 = 0x00000018
       w22 = 0xc39754b1
       w23 = 0x00000000
       w24 = 0x00000001
       w25 = 0x00000001
       w26 = 0x00000280
  ...
```

给方法加断点进入断点时x0~x7寄存器存放参数，调用完x0放返回值

打印x0寄存器值`register read x0`

通过`register write 寄存器名称 数值`格式修改寄存器上的值